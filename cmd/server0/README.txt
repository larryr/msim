Copied and modified from 'testserver'